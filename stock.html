<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Line Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    #controls {
      margin-bottom: 10px;
    }
    canvas {
      max-width: 100%;
    }
    .choices__list--multiple .choices__item {
      background-color: #007bff;
      border: none;
    }
  </style>
</head>
<body>
  <h2>ğŸ“ˆ Multi-Stock Close Price Chart</h2>
  <div id="controls">
    <label>ğŸ“Š Select stocks: </label>
    <select id="stock-select" multiple></select>

    <label>â±ï¸ Time range: </label>
    <select id="time-range">
      <option value="1week">æœ€è¿‘ä¸€å‘¨</option>
      <option value="1month">æœ€è¿‘ä¸€ä¸ªæœˆ</option>
      <option value="3months">æœ€è¿‘3ä¸ªæœˆ</option>
      <option value="6months">æœ€è¿‘6ä¸ªæœˆ</option>
      <option value="1year">æœ€è¿‘ä¸€å¹´</option>
      <option value="2years">æœ€è¿‘2å¹´</option>
      <option value="3years">æœ€è¿‘3å¹´</option>
      <option value="5years">æœ€è¿‘5å¹´</option>
      <option value="10years">æœ€è¿‘10å¹´</option>
    </select>

    <label>ğŸ“… Start date: </label>
    <input type="date" id="start-date">
    <label>End date: </label>
    <input type="date" id="end-date">
    <button id="update-btn">Update Chart</button>
  </div>

  <canvas id="chart" height="100"></canvas>

  <script>
    const apiKey = "f53465fe2af24865be6e5e4bd78dbc56";
    const availableStocks = ["AAPL", "GOOG", "SE", "TSLA", "NVDA"];
    const chartCanvas = document.getElementById("chart").getContext("2d");
    let myChart;

    const stockSelect = document.getElementById("stock-select");
    const timeRangeSelect = document.getElementById("time-range");
    const startDateInput = document.getElementById("start-date");
    const endDateInput = document.getElementById("end-date");
    const updateBtn = document.getElementById("update-btn");

    // åˆå§‹åŒ–å¤šé€‰æ¡†
    const choices = new Choices(stockSelect, {
      removeItemButton: true,
      maxItemCount: 5,
      placeholder: true,
      placeholderValue: "Select stocks",
    });

    // å¡«å……å¯é€‰è‚¡ç¥¨
    availableStocks.forEach(symbol => {
      choices.setChoices([{ value: symbol, label: symbol }], 'value', 'label', false);
    });

    function getToday() {
      return new Date().toISOString().slice(0, 10);
    }

    function getDateNDaysAgo(n) {
      const date = new Date();
      date.setDate(date.getDate() - n);
      return date.toISOString().slice(0, 10);
    }

    function getDateNMonthsAgo(n) {
      const date = new Date();
      date.setMonth(date.getMonth() - n);
      return date.toISOString().slice(0, 10);
    }

    function getDateNYearsAgo(n) {
      const date = new Date();
      date.setFullYear(date.getFullYear() - n);
      return date.toISOString().slice(0, 10);
    }

    const timeRanges = {
      '1week':   () => ({ start: getDateNDaysAgo(7), end: getToday() }),
      '1month':  () => ({ start: getDateNMonthsAgo(1), end: getToday() }),
      '3months': () => ({ start: getDateNMonthsAgo(3), end: getToday() }),
      '6months': () => ({ start: getDateNMonthsAgo(6), end: getToday() }),
      '1year':   () => ({ start: getDateNYearsAgo(1), end: getToday() }),
      '2years':  () => ({ start: getDateNYearsAgo(2), end: getToday() }),
      '3years':  () => ({ start: getDateNYearsAgo(3), end: getToday() }),
      '5years':  () => ({ start: getDateNYearsAgo(5), end: getToday() }),
      '10years': () => ({ start: getDateNYearsAgo(10), end: getToday() })
    };

    // ç»‘å®šæ—¶é—´èŒƒå›´é€‰æ‹©å˜åŒ–äº‹ä»¶
    timeRangeSelect.addEventListener("change", () => {
      const range = timeRanges[timeRangeSelect.value]();
      startDateInput.value = range.start;
      endDateInput.value = range.end;
    });

    // åˆå§‹æ—¶é—´èŒƒå›´
    const defaultRange = timeRanges["1month"]();
    startDateInput.value = defaultRange.start;
    endDateInput.value = defaultRange.end;

    async function fetchStockData(symbol, start, end) {
      const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1day&start_date=${start}&end_date=${end}&apikey=${apiKey}`;
      const response = await fetch(url);
      const data = await response.json();
      if (!data.values) return null;

      const values = data.values.map(item => ({
        date: item.datetime,
        close: parseFloat(item.close)
      }));

      return values;
    }

    function findCommonDates(dataMap) {
      const allDates = Object.values(dataMap).map(d => d.map(p => p.date));
      return allDates.reduce((a, b) => a.filter(c => b.includes(c)));
    }

    function updateChart(dates, series) {
      if (myChart) myChart.destroy();

      myChart = new Chart(chartCanvas, {
        type: 'line',
        data: {
          labels: dates,
          datasets: series.map(s => ({
            label: s.name,
            data: s.data,
            borderWidth: 2,
            fill: false
          }))
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: { mode: 'index', intersect: false },
            legend: { position: 'bottom' }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Close Price (USD)' } }
          }
        }
      });
    }

    async function loadChart() {
      updateBtn.disabled = true;
      updateBtn.textContent = "Loading...";

      const symbols = choices.getValue(true);
      const start = startDateInput.value;
      const end = endDateInput.value;

      if (!symbols.length) {
        alert("Please select at least one stock.");
        updateBtn.disabled = false;
        updateBtn.textContent = "Update Chart";
        return;
      }

      const allData = {};
      for (const symbol of symbols) {
        const values = await fetchStockData(symbol, start, end);
        if (values) {
          allData[symbol] = values;
        } else {
          alert(`No data for ${symbol}`);
        }
      }

      const commonDates = findCommonDates(allData);
      if (commonDates.length === 0) {
        alert("æ²¡æœ‰æ‰¾åˆ°æ‰€æœ‰è‚¡ç¥¨å…±åŒçš„äº¤æ˜“æ—¥ã€‚");
        updateBtn.disabled = false;
        updateBtn.textContent = "Update Chart";
        return;
      }

      const series = symbols.map(symbol => {
        const symbolData = allData[symbol].filter(p => commonDates.includes(p.date));
        return {
          name: symbol,
          data: symbolData.map(p => p.close)
        };
      });

      updateChart(commonDates.reverse(), series);
      updateBtn.disabled = false;
      updateBtn.textContent = "Update Chart";
    }

    document.getElementById("update-btn").addEventListener("click", loadChart);
  </script>
</body>
</html>

